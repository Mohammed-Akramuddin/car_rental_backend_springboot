# ================================================
# LUXURY CAR RENTAL SYSTEM - APPLICATION CONFIG
# ================================================
spring:
  application:
    name: car-rental-backend

  # ----------------------------------------
  # DATABASE CONFIGURATION (PostgreSQL / Neon)
  # ----------------------------------------
  datasource:
    # Use a single JDBC URL environment variable in production.
    # Example: jdbc:postgresql://host:port/dbname?sslmode=require
    url: ${JDBC_URL:jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:car_rental}?sslmode=require}
    username: ${DB_USERNAME:}
    password: ${DB_PASSWORD:}
    driver-class-name: org.postgresql.Driver

    # HikariCP Connection Pool Settings
    hikari:
      minimum-idle: ${DB_HIKARI_MINIMUM_IDLE:5}
      maximum-pool-size: ${DB_HIKARI_MAXIMUM_POOL_SIZE:20}
      idle-timeout: ${DB_HIKARI_IDLE_TIMEOUT:300000}
      pool-name: CarRentalHikariCP
      max-lifetime: ${DB_HIKARI_MAX_LIFETIME:1200000}
      connection-timeout: ${DB_HIKARI_CONNECTION_TIMEOUT:30000}

  # ----------------------------------------
  # SQL INITIALIZATION (schema.sql)
  # ----------------------------------------
  # Default: never - do NOT run schema on startup. Data persists across restarts.
  # For a NEW database, run once with: -Dspring.profiles.active=init-db
  sql:
    init:
      mode: never
      continue-on-error: false

  # ----------------------------------------
  # JPA / HIBERNATE CONFIGURATION
  # ----------------------------------------
  jpa:
    hibernate:
      ddl-auto: ${JPA_HIBERNATE_DDL_AUTO:none}  # default none, adjust for dev only
    show-sql: ${JPA_SHOW_SQL:false}
    properties:
      hibernate:
        format_sql: true
        dialect: org.hibernate.dialect.PostgreSQLDialect
        jdbc:
          time_zone: UTC
        order_inserts: true
        order_updates: true
        batch_versioned_data: true
    open-in-view: ${JPA_OPEN_IN_VIEW:false}  # disable OSIV for production

  # ----------------------------------------
  # MAIL CONFIGURATION (Brevo / SMTP)
  # ----------------------------------------
  # Never commit real credentials. Use environment variables.
  mail:
    host: ${MAIL_HOST:smtp-relay.brevo.com}
    port: ${MAIL_PORT:587}
    username: ${MAIL_USERNAME:}
    password: ${MAIL_PASSWORD:}
    protocol: smtp
    default-encoding: UTF-8
    properties:
      mail:
        smtp:
          auth: true
          starttls:
            enable: true
            required: true
          connectiontimeout: ${MAIL_CONNECTION_TIMEOUT:5000}
          timeout: ${MAIL_TIMEOUT:5000}
          writetimeout: ${MAIL_WRITE_TIMEOUT:5000}
          ssl:
            trust: ${MAIL_SSL_TRUST:smtp-relay.brevo.com}
          from: ${MAIL_FROM:}
    brevo:
      api-key: ${BREVO_API_KEY:}
      api-url: https://api.brevo.com/v3/smtp/email

# ----------------------------------------
# SERVER CONFIGURATION
# ----------------------------------------
server:
  port: ${SERVER_PORT:8083}
  error:
    include-message: always
    include-binding-errors: always

# ----------------------------------------
# JWT CONFIGURATION
# ----------------------------------------
# Production: set JWT_SECRET to a Base64-encoded 256-bit+ key (recommended).
# Example generate: openssl rand -base64 32
application:
  security:
    jwt:
      # This property must be set â€” no default secret is included here.
      secret-key: ${JWT_SECRET:}
      # Token expirations (milliseconds)
      expiration: ${JWT_EXPIRATION:86400000}        # 24 hours
      refresh-expiration: ${JWT_REFRESH_EXPIRATION:604800000}  # 7 days

# ----------------------------------------
# APP CONFIG (base URL, mail sender)
# ----------------------------------------
app:
  base-url: ${APP_BASE_URL:http://localhost:${SERVER_PORT:8081}}
  mail:
    from: ${MAIL_FROM:}

# ----------------------------------------
# CORS CONFIGURATION
# ----------------------------------------
# For development you may set CORS_ORIGINS to "http://localhost:3000,http://localhost:5173"
# For production set it to the actual frontend origin(s).
cors:
  allowed-origins: ${CORS_ORIGINS:http://localhost:3000,http://localhost:5173,https://velocecar.netlify.app}
  allowed-methods: ${CORS_ALLOWED_METHODS:GET,POST,PUT,PATCH,DELETE,OPTIONS}
  allowed-headers: ${CORS_ALLOWED_HEADERS:*}
  allow-credentials: ${CORS_ALLOW_CREDENTIALS:true}
  max-age: ${CORS_MAX_AGE:3600}

# ----------------------------------------
# LOGGING CONFIGURATION
# ----------------------------------------
logging:
  level:
    root: ${LOG_LEVEL_ROOT:INFO}
    com.car_rental_backend: ${LOG_LEVEL_APP:DEBUG}
    org.springframework.security: ${LOG_LEVEL_SPRING_SECURITY:INFO}
    org.springframework.mail: ${LOG_LEVEL_MAIL:INFO}
    org.hibernate.SQL: ${LOG_LEVEL_HIBERNATE_SQL:DEBUG}
    org.hibernate.type.descriptor.sql.BasicBinder: ${LOG_LEVEL_HIBERNATE_BINDER:TRACE}
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: ${LOG_FILE:logs/car-rental.log}

# ----------------------------------------
# ACTUATOR (Health Checks)
# ----------------------------------------
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
  endpoint:
    health:
      show-details: when_authorized

# ================================================
# INIT-DB PROFILE (run only when initializing a NEW database)
# ================================================
# Usage: -Dspring.profiles.active=init-db
# WARNING: Drops and recreates all tables. All data will be lost!
---
spring:
  config:
    activate:
      on-profile: init-db
  sql:
    init:
      mode: always
      continue-on-error: false

# ================================================
# PRODUCTION PROFILE
# ================================================
---
spring:
  config:
    activate:
      on-profile: prod
  sql:
    init:
      mode: never
      continue-on-error: false
  jpa:
    hibernate:
      ddl-auto: ${PROD_JPA_HIBERNATE_DDL_AUTO:none}
    show-sql: ${PROD_JPA_SHOW_SQL:false}

logging:
  level:
    root: ${PROD_LOG_LEVEL_ROOT:WARN}
    com.car_rental_backend: ${PROD_LOG_LEVEL_APP:INFO}
    org.hibernate.SQL: ${PROD_LOG_LEVEL_HIBERNATE_SQL:WARN}
